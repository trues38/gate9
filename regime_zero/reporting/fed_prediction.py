import sys
import os
import json
import pandas as pd
from datetime import datetime, timedelta

# Add project root to path
sys.path.append(os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__)))))

from regime_zero.ingest.fetch_market_data import get_market_vector
from regime_zero.ingest.fetch_headlines import get_daily_headlines
from regime_zero.engine.matcher import match_regime
from regime_zero.embedding.vectorizer import vectorize_market_state
from utils.openrouter_client import ask_llm

OUTPUT_DIR = "regime_zero/reports"

def get_regime_history(days=30):
    """Fetches regime history for the last N days."""
    history = []
    end_date = datetime.now()
    start_date = end_date - timedelta(days=days)
    
    current = start_date
    while current <= end_date:
        date_str = current.strftime("%Y-%m-%d")
        
        # We can reuse the logic from daily_report but simpler
        market_data = get_market_vector(date_str)
        headlines = get_daily_headlines(date_str)
        
        if any(market_data.values()) or headlines:
             vector, _ = vectorize_market_state(date_str, market_data, headlines)
             regime, score = match_regime(vector)
             if regime:
                 history.append({
                     "date": date_str,
                     "regime": regime['name'],
                     "score": score,
                     "market_data": market_data
                 })
        
        current += timedelta(days=1)
    return history

def generate_fed_prediction_report():
    today = datetime.now().strftime("%Y-%m-%d")
    print(f"ðŸ”® [Regime Zero] Generating Fed Prediction Report for {today}...")

    # 1. Get History
    history = get_regime_history(days=30)
    if not history:
        print("âŒ No history found.")
        return

    # 2. Prepare Context for LLM
    # We want to summarize the trend
    trend_summary = "\n".join([f"- {h['date']}: {h['regime']} (Score: {h['score']:.2f})" for h in history])
    
    latest_data = history[-1]['market_data']
    
    # Custom Prompt for Fed Prediction
    system_prompt = "You are a macro-economic strategist specializing in Federal Reserve policy prediction."
    
    user_prompt = f"""
    Analyze the following market regime trend over the last 30 days and the latest market data to predict the Federal Reserve's interest rate decision on December 10-11, 2025.
    
    ## Market Regime Trend (Last 30 Days)
    {trend_summary}
    
    ## Latest Market Data ({history[-1]['date']})
    - US 10Y Yield: {latest_data.get('^TNX', 'N/A')}
    - Dollar Index: {latest_data.get('DX-Y.NYB', 'N/A')}
    - VIX: {latest_data.get('^VIX', 'N/A')}
    - S&P 500: {latest_data.get('SPY', 'N/A')}
    - Crude Oil: {latest_data.get('CL=F', 'N/A')}
    
    ## Task
    1. Analyze the shift in regimes (if any) and what it implies about inflation and growth expectations.
    2. Predict the Fed's likely action (Hike, Cut, or Hold) and the tone (Hawkish/Dovish).
    3. Provide a probability estimate (e.g., 60% Cut, 40% Hold).
    4. Highlight key risks to this prediction.
    
    Format the output as a professional markdown report section.
    """
    
    print("ðŸ§  Asking LLM for prediction...")
    prediction = ask_llm(user_prompt, system_prompt=system_prompt)
    
    # 3. Save Report
    report = f"""# ðŸ¦ Fed Rate Prediction Report (Dec 10-11 Meeting)
    
**Date:** {today}
**Based on:** 30-day Market Regime Analysis

## ðŸ“Š Market Context
- **Trend:** Analyzed {len(history)} days of regime data.
- **Latest Regime:** {history[-1]['regime']}

## ðŸ”® Prediction & Analysis
{prediction}

---
*Generated by Regime Zero AI*
"""

    if not os.path.exists(OUTPUT_DIR):
        os.makedirs(OUTPUT_DIR)
        
    filename = f"{OUTPUT_DIR}/fed_prediction_{today}.md"
    with open(filename, "w") as f:
        f.write(report)
        
    print(f"âœ… Report saved to {filename}")
    return filename

if __name__ == "__main__":
    generate_fed_prediction_report()
